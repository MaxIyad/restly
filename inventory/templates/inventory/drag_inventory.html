{% extends 'base.html' %}
{% block content %}
<h1>Drag and Reorder Inventory</h1>

<!-- Table for inventory rows -->
<form id="inventory-form" method="post">
    {% csrf_token %}
    <ul id="inventory-list">
        {% for ingredient in ingredients %}
        <li data-id="{{ ingredient.id }}" class="inventory-item">
            <span class="drag-handle">â˜°</span>
            {{ ingredient.name }} ({{ ingredient.quantity }} {{ ingredient.unit_type }})
            <button type="button" class="delete-button" data-id="{{ ingredient.id }}">Delete</button>
        </li>
        {% endfor %}
    </ul>
    <button type="submit" id="save-order" class="btn btn-primary">Save Order</button>
</form>

<script>
    // Drag-and-drop functionality
    const inventoryList = document.getElementById('inventory-list');
    new Sortable(inventoryList, {
        animation: 150,
        handle: '.drag-handle',
        onEnd: function () {
            // Update the order in the hidden form
            const order = [...inventoryList.children].map(item => item.dataset.id);
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            order.forEach((id, index) => {
                formData.append('order[]', id);
            });

            fetch("{% url 'drag_inventory' %}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => alert(data.message))
            .catch(error => console.error('Error:', error));
        }
    });

    // Deletion functionality
    document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function () {
            const ingredientId = this.dataset.id;
            if (confirm('Are you sure you want to delete this row?')) {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                formData.append('delete_id', ingredientId);

                fetch("{% url 'drag_inventory' %}", {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.closest('li').remove();
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    });
</script>
{% endblock %}
