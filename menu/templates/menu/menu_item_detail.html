<!-- menu_item_detail.html -->

{% extends 'base.html' %}

{% block title %}
    {{ menu_item.name }}
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-primary">{{ menu_item.name }}</h1>
        <a href="{% url 'menu_detail' menu.slug %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left-circle"></i> Back to {{ category.name }}
        </a>
    </div>
    


    <!-- Add Recipe Ingredient Form -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Add Recipe Ingredient</h2>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="id_ingredient_name" class="form-label">Ingredient</label>
                    <select id="id_ingredient_name" name="ingredient_name" class="form-control">
                        <option value="">Select an ingredient</option>
                        {% for name in recipe_ingredient_form.fields.ingredient_name.choices %}
                            <option value="{{ name.0 }}">{{ name.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Placeholder(?) -->
                <div class="mb-3">
                    <label for="id_category" class="form-label">Category</label>
                    <select id="id_category" name="category" class="form-control">
                        <option value="">Select a category</option>
                    </select>
                </div>               
                
                
                <div class="mb-3">
                    <label for="id_quantity" class="form-label">Quantity</label>
                    <input type="number" id="id_quantity" name="quantity" class="form-control" step="0.01">
                </div>
                <button type="submit" name="add_ingredient" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Add Ingredient
                </button>
            </form>
        </div>
    </div>

    <!-- List Recipe Ingredients -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h2 class="mb-0">Recipe Ingredients</h2>
        </div>
        <div class="card-body">
            {% if recipe_ingredients %}
            <table class="table table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Ingredient</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Price</th> <!-- New column for price -->
                        <th>Deplete From</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for recipe_ingredient in recipe_ingredients %}
                    <tr>
                        <td>
                            <a href="{% url 'ingredient_details' recipe_ingredient.category.slug recipe_ingredient.ingredient.slug %}">
                                {{ recipe_ingredient.ingredient.name }}
                            </a>
                        </td>
                        <td>{{ recipe_ingredient.quantity }}</td>
                        <td>{{ recipe_ingredient.ingredient.unit_multiplier }}{{ recipe_ingredient.ingredient.unit_type }}</td>
                        <td>${{ recipe_ingredient.calculated_price|floatformat:2 }}</td> <!-- Display calculated price -->
                        <td>{{ recipe_ingredient.category.name }}</td>
                        <td>
                            <form method="post" style="display:inline;">
                                {% csrf_token %}
                                <input type="hidden" name="ingredient_id" value="{{ recipe_ingredient.id }}">
                                <button type="submit" name="remove_ingredient" class="btn btn-danger btn-sm">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted">No ingredients added to this recipe.</p>
            {% endif %}
        </div>
    </div>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h2 class="mb-0">Update Cost and Margin</h2>
        </div>
        <div class="card-body">
            <form method="post" id="cost-margin-form">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="cost" class="form-label">Cost ($)</label>
                    <input type="number" id="cost" name="cost" class="form-control" step="0.01" value="{{ menu_item.cost }}">
                </div>
                <div class="mb-3">
                    <label for="margin" class="form-label">Margin (%)</label>
                    <input type="number" id="margin" name="margin" class="form-control" step="0.01" value="{{ margin }}">
                </div>
                <p>Total Ingredient Cost: ${{ total_ingredient_cost|floatformat:2 }}</p>
                <button type="submit" name="update_cost" class="btn btn-success">
                    <i class="bi bi-save"></i> Save
                </button>
            </form>
        </div>
    </div>
    
    
</div>

<!-- JavaScript for Dynamic Category Loading -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ingredientSelect = document.querySelector("#id_ingredient_name");
        const categorySelect = document.querySelector("#id_category");
        const unitDisplay = document.createElement("p");
        const formBody = document.querySelector(".card-body form");

        unitDisplay.id = "unit-info";
        unitDisplay.className = "text-muted";
        formBody.appendChild(unitDisplay);

        // Fetch categories and unit info when ingredient changes
        ingredientSelect.addEventListener("change", function () {
            const ingredientName = this.value;
            categorySelect.innerHTML = '<option value="">Select a category</option>';
            unitDisplay.textContent = "";

            if (ingredientName) {
                fetch(`/get-categories-for-ingredient/?ingredient_name=${ingredientName}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.categories && data.categories.length > 0) {
                            data.categories.forEach(category => {
                                const option = document.createElement("option");
                                option.value = category.id;
                                option.textContent = category.name;
                                option.dataset.unitMultiplier = category.unit_multiplier;
                                option.dataset.unitType = category.unit_type;
                                categorySelect.appendChild(option);
                            });
                        } else {
                            console.log("No categories found for the selected ingredient.");
                        }
                    })
                    .catch(error => console.error("Error fetching categories:", error));
            }
        });

        // Update unit display when category changes
        categorySelect.addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            const unitMultiplier = selectedOption.dataset.unitMultiplier || "";
            const unitType = selectedOption.dataset.unitType || "";

            if (unitMultiplier && unitType) {
                unitDisplay.textContent = `Unit: ${unitMultiplier}${unitType}`;
            } else {
                unitDisplay.textContent = "No unit information available.";
            }
        });
    });
</script>


<!-- Cost Calcuator Updater -->

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const costInput = document.getElementById("cost");
        const marginInput = document.getElementById("margin");
        const totalIngredientCost = parseFloat({{ total_ingredient_cost|floatformat:2 }});
    
        costInput.addEventListener("input", function () {
            const cost = parseFloat(costInput.value);
            if (!isNaN(cost)) {
                marginInput.value = (((cost - totalIngredientCost) / totalIngredientCost) * 100).toFixed(2);
            }
        });
    
        marginInput.addEventListener("input", function () {
            const margin = parseFloat(marginInput.value);
            if (!isNaN(margin)) {
                costInput.value = (totalIngredientCost * (1 + margin / 100)).toFixed(2);
            }
        });
    });
    </script>
    

{% endblock %}
